<!DOCTYPE html>

<html>
<head>
  <title>can-observation</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page_wrapper">
            <div id="jump_page">
              
                
                <a class="source" href="can-observation.html">
                  can-observation.js
                </a>
              
                
                <a class="source" href="recorder-dependency-helpers.html">
                  recorder-dependency-helpers.js
                </a>
              
                
                <a class="source" href="temporarily-bind.html">
                  temporarily-bind.js
                </a>
              
            </div>
          </div>
        </li>
      </ul>
    
    <ul class="sections">
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-comment">/* global require */</span></pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <h1 id="can-observation">can-observation</h1>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">var</span> namespace = <span class="hljs-built_in">require</span>(<span class="hljs-string">'can-namespace'</span>);
<span class="hljs-keyword">var</span> canReflect = <span class="hljs-built_in">require</span>(<span class="hljs-string">'can-reflect'</span>);
<span class="hljs-keyword">var</span> queues = <span class="hljs-built_in">require</span>(<span class="hljs-string">"can-queues"</span>);
<span class="hljs-keyword">var</span> ObservationRecorder = <span class="hljs-built_in">require</span>(<span class="hljs-string">"can-observation-recorder"</span>);

<span class="hljs-keyword">var</span> canSymbol = <span class="hljs-built_in">require</span>(<span class="hljs-string">"can-symbol"</span>);
<span class="hljs-keyword">var</span> dev = <span class="hljs-built_in">require</span>(<span class="hljs-string">"can-log/dev/dev"</span>);
<span class="hljs-keyword">var</span> valueEventBindings = <span class="hljs-built_in">require</span>(<span class="hljs-string">"can-event-queue/value/value"</span>);

<span class="hljs-keyword">var</span> recorderHelpers = <span class="hljs-built_in">require</span>(<span class="hljs-string">"./recorder-dependency-helpers"</span>);
<span class="hljs-keyword">var</span> temporarilyBind = <span class="hljs-built_in">require</span>(<span class="hljs-string">"./temporarily-bind"</span>);

<span class="hljs-keyword">var</span> dispatchSymbol = canSymbol.for(<span class="hljs-string">"can.dispatch"</span>);
<span class="hljs-keyword">var</span> getChangesSymbol = canSymbol.for(<span class="hljs-string">"can.getChangesDependencyRecord"</span>);
<span class="hljs-keyword">var</span> getValueDependenciesSymbol = canSymbol.for(<span class="hljs-string">"can.getValueDependencies"</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <h2 id="observation-constructor">Observation constructor</h2>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">Observation</span>(<span class="hljs-params">func, context, options</span>)</span>{
	<span class="hljs-keyword">this</span>.func = func;
	<span class="hljs-keyword">this</span>.context = context;
	<span class="hljs-keyword">this</span>.options = options || {<span class="hljs-attr">priority</span>: <span class="hljs-number">0</span>, <span class="hljs-attr">isObservable</span>: <span class="hljs-literal">true</span>};</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>A flag if we are bound or not</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	<span class="hljs-keyword">this</span>.bound = <span class="hljs-literal">false</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>These properties will manage what our new and old dependencies are.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	<span class="hljs-keyword">this</span>.newDependencies = ObservationRecorder.makeDependenciesRecord();
	<span class="hljs-keyword">this</span>.oldDependencies = <span class="hljs-literal">null</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>Make functions we need to pass around and maintain <code>this</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	<span class="hljs-keyword">var</span> self = <span class="hljs-keyword">this</span>;
	<span class="hljs-keyword">this</span>.onDependencyChange = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">newVal</span>)</span>{
		self.dependencyChange(<span class="hljs-keyword">this</span>, newVal);
	};
	<span class="hljs-keyword">this</span>.update = <span class="hljs-keyword">this</span>.update.bind(<span class="hljs-keyword">this</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>Add debugging names.
!steal-remove-start</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	<span class="hljs-keyword">this</span>.onDependencyChange[getChangesSymbol] = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getChanges</span>(<span class="hljs-params"></span>) </span>{
		<span class="hljs-keyword">return</span> {
			<span class="hljs-attr">valueDependencies</span>: <span class="hljs-keyword">new</span> <span class="hljs-built_in">Set</span>([self])
		};
	};
	<span class="hljs-built_in">Object</span>.defineProperty(<span class="hljs-keyword">this</span>.onDependencyChange, <span class="hljs-string">"name"</span>, {
		<span class="hljs-attr">value</span>: canReflect.getName(<span class="hljs-keyword">this</span>) + <span class="hljs-string">".onDependencyChange"</span>,
	});
	<span class="hljs-built_in">Object</span>.defineProperty(<span class="hljs-keyword">this</span>.update, <span class="hljs-string">"name"</span>, {
		<span class="hljs-attr">value</span>: canReflect.getName(<span class="hljs-keyword">this</span>) + <span class="hljs-string">".update"</span>,
	});</pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>!steal-remove-end</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>}</pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <h2 id="observation-prototype-methods">Observation prototype methods</h2>

            </div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p>Mixin value event bindings. This is where the following are added:</p>
<ul>
<li><code>.handlers</code> which call <code>onBound</code> and <code>onUnbound</code></li>
<li><code>.on</code> / <code>.off</code></li>
<li><code>can.onValue</code> <code>can.offValue</code></li>
<li><code>can.getWhatIChange</code></li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>valueEventBindings(Observation.prototype);

canReflect.assign(Observation.prototype, {</pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <p>Starts observing changes and adds event listeners.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	onBound: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)</span>{
		<span class="hljs-keyword">this</span>.bound = <span class="hljs-literal">true</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <p>Store the old dependencies</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>		<span class="hljs-keyword">this</span>.oldDependencies = <span class="hljs-keyword">this</span>.newDependencies;</pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <p>Start recording dependencies.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>		ObservationRecorder.start();</pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <p>Call the observation’s function and update the new value.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>		<span class="hljs-keyword">this</span>.value = <span class="hljs-keyword">this</span>.func.call(<span class="hljs-keyword">this</span>.context);</pre></div></div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <p>Get the new dependencies.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>		<span class="hljs-keyword">this</span>.newDependencies = ObservationRecorder.stop();</pre></div></div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <p>Diff and update the bindings. On change, everything will call
<code>this.onDependencyChange</code>, which calls <code>this.dependencyChange</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>		recorderHelpers.updateObservations(<span class="hljs-keyword">this</span>);
	},</pre></div></div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              <p>This is called when any of the dependencies change.
It queues up an update in the <code>deriveQueue</code> to be run after all source
observables have had time to notify all observables that “derive” their value.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	dependencyChange: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">context, args</span>)</span>{
		<span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>.bound === <span class="hljs-literal">true</span>) {</pre></div></div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-18">&#182;</a>
              </div>
              <p>Update this observation after all <code>notify</code> tasks have been run.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>			queues.deriveQueue.enqueue(
				<span class="hljs-keyword">this</span>.update,
				<span class="hljs-keyword">this</span>,
				[],
				{
					<span class="hljs-attr">priority</span>: <span class="hljs-keyword">this</span>.options.priority</pre></div></div>
            
        </li>
        
        
        <li id="section-19">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-19">&#182;</a>
              </div>
              <p>!steal-remove-start</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>					<span class="hljs-comment">/* jshint laxcomma: true */</span>
					, <span class="hljs-attr">log</span>: [ canReflect.getName(<span class="hljs-keyword">this</span>.update) ]
					<span class="hljs-comment">/* jshint laxcomma: false */</span></pre></div></div>
            
        </li>
        
        
        <li id="section-20">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-20">&#182;</a>
              </div>
              <p>!steal-remove-end</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>				}</pre></div></div>
            
        </li>
        
        
        <li id="section-21">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-21">&#182;</a>
              </div>
              <p>!steal-remove-start</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>				<span class="hljs-comment">/* jshint laxcomma: true */</span>
				, [canReflect.getName(context), <span class="hljs-string">"changed"</span>]
				<span class="hljs-comment">/* jshint laxcomma: false */</span></pre></div></div>
            
        </li>
        
        
        <li id="section-22">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-22">&#182;</a>
              </div>
              <p>!steal-remove-end</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>			);
		}
	},</pre></div></div>
            
        </li>
        
        
        <li id="section-23">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-23">&#182;</a>
              </div>
              <p>Called to update its value as part of the <code>derive</code> queue.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	update: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
		<span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.bound === <span class="hljs-literal">true</span>) {</pre></div></div>
            
        </li>
        
        
        <li id="section-24">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-24">&#182;</a>
              </div>
              <p>Keep the old value.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>			<span class="hljs-keyword">var</span> oldValue = <span class="hljs-keyword">this</span>.value;
			<span class="hljs-keyword">this</span>.oldValue = <span class="hljs-literal">null</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-25">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-25">&#182;</a>
              </div>
              <p>Re-run <code>this.func</code> and update dependency bindings.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>			<span class="hljs-keyword">this</span>.onBound();</pre></div></div>
            
        </li>
        
        
        <li id="section-26">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-26">&#182;</a>
              </div>
              <p>If our value changed, call the <code>dispatch</code> method provided by <code>can-event-queue/value/value</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>			<span class="hljs-keyword">if</span> (oldValue !== <span class="hljs-keyword">this</span>.value) {
				<span class="hljs-keyword">this</span>[dispatchSymbol](<span class="hljs-keyword">this</span>.value, oldValue);
			}
		}
	},</pre></div></div>
            
        </li>
        
        
        <li id="section-27">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-27">&#182;</a>
              </div>
              <p>Called when nothing is bound to this observation.
Removes all event listeners on all dependency observables.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	onUnbound: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)</span>{
		<span class="hljs-keyword">this</span>.bound = <span class="hljs-literal">false</span>;
		recorderHelpers.stopObserving(<span class="hljs-keyword">this</span>.newDependencies, <span class="hljs-keyword">this</span>.onDependencyChange);</pre></div></div>
            
        </li>
        
        
        <li id="section-28">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-28">&#182;</a>
              </div>
              <p>Setup newDependencies in case someone binds again to this observable.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>		<span class="hljs-keyword">this</span>.newDependencies = ObservationRecorder.makeDependenciesRecorder();
	},</pre></div></div>
            
        </li>
        
        
        <li id="section-29">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-29">&#182;</a>
              </div>
              <p>Reads the value of the observation.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	get: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)</span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-30">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-30">&#182;</a>
              </div>
              <p>If an external observation is tracking observables and
this compute can be listened to by “function” based computes ….</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>		<span class="hljs-keyword">if</span>( <span class="hljs-keyword">this</span>.options.isObservable &amp;&amp; ObservationRecorder.isRecording() ) {</pre></div></div>
            
        </li>
        
        
        <li id="section-31">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-31">&#182;</a>
              </div>
              <p>… tell the tracking compute to listen to change on this observation.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>			ObservationRecorder.add(<span class="hljs-keyword">this</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-32">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-32">&#182;</a>
              </div>
              <p>… if we are not bound, we should bind so that
we don’t have to re-read to get the value of this observation.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>			<span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.bound) {
				Observation.temporarilyBind(<span class="hljs-keyword">this</span>);
			}

		}


		<span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>.bound === <span class="hljs-literal">true</span> ) {</pre></div></div>
            
        </li>
        
        
        <li id="section-33">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-33">&#182;</a>
              </div>
              <p>It’s possible that a child dependency of this observable might be queued
to change. Check all child dependencies and make sure they are up-to-date by
possibly running what they have registered in the derive queue.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>			<span class="hljs-keyword">if</span>(queues.deriveQueue.tasksRemainingCount() &gt; <span class="hljs-number">0</span>) {
				Observation.updateChildrenAndSelf(<span class="hljs-keyword">this</span>);
			}

			<span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.value;
		} <span class="hljs-keyword">else</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-34">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-34">&#182;</a>
              </div>
              <p>If we are not bound, just call the function.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>			<span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.func.call(<span class="hljs-keyword">this</span>.context);
		}
	},

	<span class="hljs-attr">hasDependencies</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)</span>{
		<span class="hljs-keyword">var</span> newDependencies = <span class="hljs-keyword">this</span>.newDependencies;
		<span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.bound ?
			(newDependencies.valueDependencies.size + newDependencies.keyDependencies.size) &gt; <span class="hljs-number">0</span>  :
			<span class="hljs-literal">undefined</span>;
	},
	<span class="hljs-attr">log</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-35">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-35">&#182;</a>
              </div>
              <p>!steal-remove-start</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>		<span class="hljs-keyword">var</span> quoteString = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">quoteString</span>(<span class="hljs-params">x</span>) </span>{
			<span class="hljs-keyword">return</span> <span class="hljs-keyword">typeof</span> x === <span class="hljs-string">"string"</span> ? <span class="hljs-built_in">JSON</span>.stringify(x) : x;
		};
		<span class="hljs-keyword">this</span>._log = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">previous, current</span>) </span>{
			dev.log(
				canReflect.getName(<span class="hljs-keyword">this</span>),
				<span class="hljs-string">"\n is  "</span>, quoteString(current),
				<span class="hljs-string">"\n was "</span>, quoteString(previous)
			);
		};</pre></div></div>
            
        </li>
        
        
        <li id="section-36">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-36">&#182;</a>
              </div>
              <p>!steal-remove-end</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	}
});

canReflect.assignSymbols(Observation.prototype, {
	<span class="hljs-string">"can.getValue"</span>: Observation.prototype.get,
	<span class="hljs-string">"can.isValueLike"</span>: <span class="hljs-literal">true</span>,
	<span class="hljs-string">"can.isMapLike"</span>: <span class="hljs-literal">false</span>,
	<span class="hljs-string">"can.isListLike"</span>: <span class="hljs-literal">false</span>,
	<span class="hljs-string">"can.valueHasDependencies"</span>: Observation.prototype.hasDependencies,
	<span class="hljs-string">"can.getValueDependencies"</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)</span>{
		<span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.bound === <span class="hljs-literal">true</span>) {</pre></div></div>
            
        </li>
        
        
        <li id="section-37">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-37">&#182;</a>
              </div>
              <p>Only provide <code>keyDependencies</code> and <code>valueDependencies</code> properties
if there’s actually something there.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>			<span class="hljs-keyword">var</span> deps = <span class="hljs-keyword">this</span>.newDependencies,
				result = {};

			<span class="hljs-keyword">if</span> (deps.keyDependencies.size) {
				result.keyDependencies = deps.keyDependencies;
			}

			<span class="hljs-keyword">if</span> (deps.valueDependencies.size) {
				result.valueDependencies = deps.valueDependencies;
			}

			<span class="hljs-keyword">return</span> result;
		}
		<span class="hljs-keyword">return</span> <span class="hljs-literal">undefined</span>;
	},
	<span class="hljs-string">"can.getPriority"</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)</span>{
		<span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.options.priority;
	},
	<span class="hljs-string">"can.setPriority"</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">priority</span>)</span>{
		<span class="hljs-keyword">this</span>.options.priority = priority;
	},</pre></div></div>
            
        </li>
        
        
        <li id="section-38">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-38">&#182;</a>
              </div>
              <p>!steal-remove-start</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	<span class="hljs-string">"can.getName"</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
		<span class="hljs-keyword">return</span> canReflect.getName(<span class="hljs-keyword">this</span>.constructor) + <span class="hljs-string">"&lt;"</span> + canReflect.getName(<span class="hljs-keyword">this</span>.func) + <span class="hljs-string">"&gt;"</span>;
	}</pre></div></div>
            
        </li>
        
        
        <li id="section-39">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-39">&#182;</a>
              </div>
              <p>!steal-remove-end</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>});</pre></div></div>
            
        </li>
        
        
        <li id="section-40">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-40">&#182;</a>
              </div>
              <h2 id="observation-updatechildrenandself">Observation.updateChildrenAndSelf</h2>
<p>This recursively checks if an observation’s dependencies might be in the <code>derive</code> queue.
If it is, we need to update that value so the reading of this value will be correct.
This can happen if an observation suddenly switches to depending on something that has higher
priority than itself.  We need to make sure that value is completely updated.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>Observation.updateChildrenAndSelf = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">observation</span>)</span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-41">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-41">&#182;</a>
              </div>
              <p>If the observable has an <code>update</code> method and it’s enqueued, flush that task immediately so
the value is right.</p>
<blockquote>
<p>NOTE: This only works for <code>Observation</code> right now.  We need a way of knowing how
to find what an observable might have in the <code>deriveQueue</code>.</p>
</blockquote>

            </div>
            
            <div class="content"><div class='highlight'><pre>	<span class="hljs-keyword">if</span>(observation.update !== <span class="hljs-literal">undefined</span> &amp;&amp; queues.deriveQueue.isEnqueued( observation.update ) === <span class="hljs-literal">true</span>) {</pre></div></div>
            
        </li>
        
        
        <li id="section-42">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-42">&#182;</a>
              </div>
              <p>TODO: In the future, we should be able to send log information
to explain why this needed to be updated.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>		queues.deriveQueue.flushQueuedTask(observation.update);
		<span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
	}</pre></div></div>
            
        </li>
        
        
        <li id="section-43">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-43">&#182;</a>
              </div>
              <p>If we can get dependency values from this observable …</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	<span class="hljs-keyword">if</span>(observation[getValueDependenciesSymbol]) {</pre></div></div>
            
        </li>
        
        
        <li id="section-44">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-44">&#182;</a>
              </div>
              <p>… Loop through each dependency and see if any of them (or their children) needed an update.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>		<span class="hljs-keyword">var</span> childHasChanged = <span class="hljs-literal">false</span>;
		<span class="hljs-keyword">var</span> valueDependencies = observation[getValueDependenciesSymbol]().valueDependencies || [];
		valueDependencies.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">observable</span>)</span>{
			<span class="hljs-keyword">if</span>( Observation.updateChildrenAndSelf( observable ) === <span class="hljs-literal">true</span>) {
				childHasChanged = <span class="hljs-literal">true</span>;
			}
		});
		<span class="hljs-keyword">return</span> childHasChanged;
	} <span class="hljs-keyword">else</span> {
		<span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
	}
};</pre></div></div>
            
        </li>
        
        
        <li id="section-45">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-45">&#182;</a>
              </div>
              <h2 id="legacy-stuff">Legacy Stuff</h2>
<p>Warn when <code>ObservationRecorder</code> methods are called on <code>Observation</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">var</span> alias = {<span class="hljs-attr">addAll</span>: <span class="hljs-string">"addMany"</span>};
[<span class="hljs-string">"add"</span>,<span class="hljs-string">"addAll"</span>,<span class="hljs-string">"ignore"</span>,<span class="hljs-string">"trap"</span>,<span class="hljs-string">"trapsCount"</span>,<span class="hljs-string">"isRecording"</span>].forEach(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">methodName</span>)</span>{
	Observation[methodName] = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)</span>{
		<span class="hljs-keyword">var</span> name = alias[methodName] ? alias[methodName] : methodName;
		<span class="hljs-built_in">console</span>.warn(<span class="hljs-string">"can-observation: Call "</span>+name+<span class="hljs-string">"() on can-observation-recorder."</span>);
		<span class="hljs-keyword">return</span> ObservationRecorder[name].apply(<span class="hljs-keyword">this</span>, <span class="hljs-built_in">arguments</span>);
	};
});
Observation.prototype.start = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)</span>{
	<span class="hljs-built_in">console</span>.warn(<span class="hljs-string">"can-observation: Use .on and .off to bind."</span>);
	<span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.onBound();
};
Observation.prototype.stop = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)</span>{
	<span class="hljs-built_in">console</span>.warn(<span class="hljs-string">"can-observation: Use .on and .off to bind."</span>);
	<span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.onUnbound();
};</pre></div></div>
            
        </li>
        
        
        <li id="section-46">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-46">&#182;</a>
              </div>
              <h3 id="temporarilybind">temporarilyBind</h3>
<p>Will bind an observable value temporarily.  This should be part of queues probably.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>Observation.temporarilyBind = temporarilyBind;


<span class="hljs-built_in">module</span>.exports = namespace.Observation = Observation;</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
